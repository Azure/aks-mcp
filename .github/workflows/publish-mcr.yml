name: Publish to MCR

on:
  # Manual trigger for testing and ad-hoc releases
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag (e.g., v1.2.3)"
        required: true
      ghcr_image:
        description: "GHCR source image (optional, defaults to ghcr.io/azure/aks-mcp:<tag>)"
        required: false

  # Automatic trigger after SLSA releaser completes
  workflow_run:
    workflows: ["SLSA releaser"]
    types: [completed]

permissions:
  contents: read
  packages: read

env:
  GHCR_REGISTRY: ghcr.io
  GHCR_IMAGE_NAME: azure/aks-mcp

jobs:
  publish-to-mcr:
    # Only run on successful workflow_run or manual dispatch
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on:
      labels: ["self-hosted", "1ES.Pool=1es-aks-mcp-agent-pool-ubuntu"]
    environment: publish-mcr
    outputs:
      version: ${{ steps.version.outputs.version }}
      mcr_image: ${{ steps.push.outputs.mcr_image }}
      digest: ${{ steps.verify.outputs.digest }}
    steps:
      - name: Determine version and source image
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
            GHCR_IMAGE="${{ github.event.inputs.ghcr_image }}"
          else
            # Extract tag from workflow_run ref (refs/tags/v1.2.3 -> v1.2.3)
            TAG="${{ github.event.workflow_run.head_branch }}"
            if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
              echo "Not a version tag, skipping MCR publish"
              exit 0
            fi
          fi

          # Use provided GHCR image or construct default
          if [ -z "$GHCR_IMAGE" ]; then
            GHCR_IMAGE="${{ env.GHCR_REGISTRY }}/${{ env.GHCR_IMAGE_NAME }}:${TAG}"
          fi

          # Keep the version with 'v' prefix for MCR
          VERSION="${TAG}"

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "ghcr_image=${GHCR_IMAGE}" >> "$GITHUB_OUTPUT"

          echo "Git Tag: ${TAG}"
          echo "MCR Version: ${VERSION}"
          echo "Source GHCR Image: ${GHCR_IMAGE}"
          echo "Note: MCR version keeps 'v' prefix to match GHCR"

      - name: Authenticate to Azure
        run: |
          az login --identity
          az account show

      - name: Authenticate to MCR
        run: |
          az acr login -n ${{ secrets.AKS_MCP_MCR_REGISTRY }}

      - name: Authenticate to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.GHCR_REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Pull image from GHCR
        id: pull
        run: |
          GHCR_IMAGE="${{ steps.version.outputs.ghcr_image }}"
          echo "Pulling image: ${GHCR_IMAGE}"
          docker pull ${GHCR_IMAGE}

          # Get the digest from GHCR
          GHCR_DIGEST=$(docker inspect ${GHCR_IMAGE} --format='{{index .RepoDigests 0}}')
          echo "ghcr_digest=${GHCR_DIGEST}" >> "$GITHUB_OUTPUT"
          echo "GHCR Digest: ${GHCR_DIGEST}"

      - name: Tag and push to MCR
        id: push
        run: |
          GHCR_IMAGE="${{ steps.version.outputs.ghcr_image }}"
          VERSION="${{ steps.version.outputs.version }}"
          MCR_REGISTRY="${{ secrets.AKS_MCP_MCR_REGISTRY }}"
          MCR_IMAGE="${MCR_REGISTRY}.azurecr.io/public/aks/aks-mcp"

          # Tag with version
          echo "Tagging image for MCR: ${MCR_IMAGE}:${VERSION}"
          docker tag ${GHCR_IMAGE} ${MCR_IMAGE}:${VERSION}

          # Also tag as latest
          echo "Tagging image for MCR: ${MCR_IMAGE}:latest"
          docker tag ${GHCR_IMAGE} ${MCR_IMAGE}:latest

          # Push version tag
          echo "Pushing ${MCR_IMAGE}:${VERSION}"
          docker push ${MCR_IMAGE}:${VERSION}

          # Push latest tag
          echo "Pushing ${MCR_IMAGE}:latest"
          docker push ${MCR_IMAGE}:latest

          echo "mcr_image=${MCR_IMAGE}:${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Successfully pushed to MCR"

      - name: Verify digest consistency
        id: verify
        run: |
          GHCR_DIGEST="${{ steps.pull.outputs.ghcr_digest }}"
          MCR_IMAGE="${{ steps.push.outputs.mcr_image }}"

          # Pull the MCR image to get its digest
          docker pull ${MCR_IMAGE}
          MCR_DIGEST=$(docker inspect ${MCR_IMAGE} --format='{{index .RepoDigests 0}}')

          echo "GHCR Digest: ${GHCR_DIGEST}"
          echo "MCR Digest:  ${MCR_DIGEST}"

          # Extract just the sha256 part for comparison
          GHCR_SHA=$(echo ${GHCR_DIGEST} | cut -d'@' -f2)
          MCR_SHA=$(echo ${MCR_DIGEST} | cut -d'@' -f2)

          if [ "${GHCR_SHA}" = "${MCR_SHA}" ]; then
            echo "✅ Digest verification PASSED - Images are identical"
            echo "digest=${MCR_SHA}" >> "$GITHUB_OUTPUT"
          else
            echo "❌ Digest verification FAILED - Images differ!"
            echo "GHCR SHA: ${GHCR_SHA}"
            echo "MCR SHA:  ${MCR_SHA}"
            exit 1
          fi

      - name: Summary
        run: |
          echo "## MCR Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Successfully published to MCR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Tag**: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **MCR Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Source Image**: ${{ steps.version.outputs.ghcr_image }}" >> $GITHUB_STEP_SUMMARY
          echo "- **MCR Image**: ${{ steps.push.outputs.mcr_image }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: ${{ steps.verify.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verification" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.push.outputs.mcr_image }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
